<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>久坐提醒</title>
    <link rel="icon" type="image/png" href="icon-1.png" />

    <style>
      :root {
        --bg-color: #f0f3f7;
        --card-bg: #ffffff;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --primary: #2ecc71;
        --danger: #e74c3c;
        --track-bg: #e9ecef;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background-color: var(--bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        touch-action: none;
      }

      .container {
        width: 85%;
        max-width: 800px;
        /* 使用 min-height 确保在小屏幕上不会缩得太小 */
        height: 75vh;
        min-height: 350px;
        max-height: 500px;

        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;

        background: var(--card-bg);
        padding: 50px 30px; /* 使用固定像素内边距，布局更稳固 */
        border-radius: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        text-align: center;
        box-sizing: border-box;
        transition: all 0.5s ease;
      }

      .timer-display {
        /* 使用 clamp 限制字体大小范围，防止在超大或超小屏幕失控 */
        font-size: clamp(4rem, 18vw, 6rem);
        font-weight: 800;
        color: var(--text-main);
        letter-spacing: -2px;
        font-variant-numeric: tabular-nums;
        margin: 0; /* 移除 Margin，由容器分配间距 */
        line-height: 1;
      }

      .status-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-sub);
        margin: 0;
        min-height: 3rem; /* 固定高度防止文字换行时抖动 */
        display: flex;
        align-items: center;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* 让文字颜色和内容切换更柔和 */
      }

      .progress-wrapper {
        width: 100%;
        position: relative;
        padding: 20px 0; /* 增加触摸感应区域 */
        touch-action: none;
        cursor: pointer;
      }

      .progress-container {
        position: relative;
        width: 100%;
        height: 64px;
        border-radius: 20px;
        overflow: visible;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);

        /* 从绿到黄再到红的平滑过渡 */
        background: linear-gradient(
          to right,
          rgba(46, 204, 113, 0.15) 0%,
          /* 纯绿开始 */ rgba(46, 204, 113, 0.15) 37.5%,
          /* 45分钟处：依然是纯绿 */ rgba(241, 196, 15, 0.15) 60%,
          /* 开始向黄色过渡 (约72分钟) */ rgba(231, 76, 60, 0.15) 100%
            /* 最后到达危险红 */
        );
      }

      /* 在 45 分钟（37.5%）处加一个微弱的呼吸灯提示，既不挡数字，又起引导作用 */
      .progress-container::before {
        content: "";
        position: absolute;
        left: 37.5%;
        top: 0;
        width: 2px;
        height: 100%;
        background: rgba(255, 255, 255, 1); /* 极细白线，像刻度一样 */
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        z-index: 2;
      }

      .progress-mask {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 20px;
        overflow: hidden;
        pointer-events: none;
      }

      /* 在代码第 152 行左右 */
      @keyframes glow-breathe {
        0% {
          filter: brightness(1);
          box-shadow: 0 0 10px var(--current-glow-color);
        }
        100% {
          filter: brightness(1.2);
          box-shadow: 0 0 15px 2px var(--current-glow-color),
            inset 0 0 8px rgba(255, 255, 255, 0.3);
        }
      }

      /* 优化后的进度条填充样式 */
      .progress-fill {
        height: 100%;
        width: 0%;
        --current-glow-color: rgba(46, 204, 113, 0.6);
        background-color: var(--primary);

        /* 添加内部高光纹理，让进度条本身看起来有玻璃质感 */
        background-image: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.3) 0%,
          transparent 50%,
          rgba(0, 0, 0, 0.1) 100%
        );

        transition: width 0.4s cubic-bezier(0.23, 1, 0.32, 1),
          background 0.5s linear;

        animation: glow-breathe 2s infinite alternate ease-in-out;
      }

      .marker {
        position: absolute;
        top: 50%;
        height: 80px; /* 标尺稍微高出进度条 */
        width: 8px;
        background-color: var(--text-main);
        border-radius: 10px;
        z-index: 10;
        display: none;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }

      .hint {
        font-size: 0.85rem;
        font-weight: 500;
        color: #b2bec3;
        letter-spacing: 1px;
        margin: 0;
      }

      /* 报警动画优化 */
      @keyframes alert-pulse {
        0% {
          transform: scale(1);
          background-color: #ffffff;
        }
        100% {
          transform: scale(1.02);
          background-color: #fff5f5;
        }
      }

      .danger-mode .container {
        animation: alert-pulse 0.5s infinite alternate ease-in-out;
        border: 2px solid var(--danger);
      }

      /* 默认隐藏提示按钮 */
      #landscape-suggestion {
        display: none;
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
      }

      /* 仅在手机端 (宽度小于600px) 且处于竖屏时显示 */
      @media screen and (orientation: portrait) and (max-width: 600px) {
        #landscape-suggestion {
          display: block;
          animation: fadeInUp 0.8s ease-out;
        }
      }

      #landscape-suggestion button {
        background: rgba(45, 52, 54, 0.95);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.1);
        padding: 12px 28px;
        border-radius: 100px; /* 圆角胶囊形状 */
        backdrop-filter: blur(10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #landscape-suggestion small {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 4px;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translate(-50%, 30px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }
    </style>
  </head>
  <body>
    <div id="landscape-suggestion">
      <button onclick="requestLandscape()">
        <span style="font-size: 20px">⇄ 旋转</span>
        <small>横屏视野更舒适</small>
      </button>
    </div>
    <div class="container" id="app">
      <div class="timer-display" id="countdown">00:00</div>
      <div class="status-text" id="status">滑动时间轴设定提醒</div>

      <div class="progress-wrapper" id="touchZone">
        <div class="progress-container">
          <div class="marker" id="marker"></div>
          <div class="progress-mask">
            <div class="progress-fill" id="fill"></div>
          </div>
        </div>
      </div>

      <div class="hint" id="hint"></div>
    </div>

    <audio id="alarm" loop>
      <source
        src="https://www.soundjay.com/buttons/beep-01a.mp3"
        type="audio/mpeg"
      />
    </audio>

    <script>
      const touchZone = document.getElementById("touchZone");
      const fill = document.getElementById("fill");
      const marker = document.getElementById("marker");
      const status = document.getElementById("status");
      const alarm = document.getElementById("alarm");
      const countdown = document.getElementById("countdown");

      let startTime = 0;
      let targetSeconds = 0;
      let timer = null;
      let isDragging = false;
      const MAX_MINUTES = 120;

      let isPreviewing = false;
      let previewTimer = null;

      function getStatusConfig(mins) {
        if (mins < 30) {
          return { text: "充满活力", color: "#2ecc71" }; // 翠绿色
        } else if (mins < 45) {
          return { text: "专注中", color: "#a2dd58" }; // 浅绿色
        } else if (mins < 60) {
          return { text: "建议走动", color: "#f39c12" }; // 橙黄色
        } else {
          return { text: "严重久坐", color: "#e74c3c" }; // 红色
        }
      }

      // 颜色插值算法
      function getScientificColor(mins) {
        if (mins <= 45) return "#2ecc71"; // 绿色
        if (mins <= 60)
          return interpolateColor("#2ecc71", "#f1c40f", (mins - 45) / 15); // 绿到黄
        if (mins <= 90)
          return interpolateColor("#f1c40f", "#e67e22", (mins - 60) / 30); // 黄到橙
        return interpolateColor("#e67e22", "#e74c3c", (mins - 90) / 30); // 橙到红
      }

      function interpolateColor(c1, c2, factor) {
        const hex = (x) => parseInt(x.replace("#", ""), 16);
        const r1 = (hex(c1) >> 16) & 0xff,
          g1 = (hex(c1) >> 8) & 0xff,
          b1 = hex(c1) & 0xff;
        const r2 = (hex(c2) >> 16) & 0xff,
          g2 = (hex(c2) >> 8) & 0xff,
          b2 = hex(c2) & 0xff;
        const r = Math.round(r1 + factor * (r2 - r1));
        const g = Math.round(g1 + factor * (g2 - g1));
        const b = Math.round(b1 + factor * (b2 - b1));
        return `rgb(${r}, ${g}, ${b})`;
      }

      // 在脚本开头定义一个变量记录上次震动的分钟数
      let lastVibratedMin = -1;

      // 修改原有的交互逻辑，确保手动滑动时依然可以重置旧的计时
      function handlePosition(clientX) {
        // 如果在报警时手动滑动，先关掉报警
        if (document.body.classList.contains("danger-mode")) {
          resetState();
        }

        isPreviewing = true; // 开启预览模式
        if (previewTimer) clearTimeout(previewTimer); // 如果正在滑动，清除之前的倒计时

        const hintElement = document.getElementById("hint");
        if (hintElement) hintElement.innerText = "";

        const rect = touchZone
          .querySelector(".progress-container")
          .getBoundingClientRect();
        let percentage = (clientX - rect.left) / rect.width;
        percentage = Math.max(0, Math.min(1, percentage));

        const mins = Math.round(percentage * MAX_MINUTES);
        if (mins === 0) return;

        targetSeconds = mins * 60;
        marker.style.left = `${(mins / MAX_MINUTES) * 100}%`;
        marker.style.display = "block";

        status.innerText = `将在坐满 ${mins} 分钟时提醒`;
        status.style.color = getScientificColor(mins);

        if (navigator.vibrate && mins !== lastVibratedMin) {
          navigator.vibrate(50);
          lastVibratedMin = mins;
        }
      }

      function startTiming() {
        if (targetSeconds <= 0) return;
        resetState();
        startTime = Date.now();
        if (timer) clearInterval(timer);
        timer = setInterval(update, 500);
      }

      function update() {
        if (startTime === 0) return;

        const elapsedSeconds = (Date.now() - startTime) / 1000;
        const elapsedMins = elapsedSeconds / 60;

        // 更新计时显示 (即使超过目标也会继续走)
        countdown.innerText = formatTime(elapsedSeconds);

        // 进度条宽度
        const currentProgress = (elapsedSeconds / (MAX_MINUTES * 60)) * 100;
        fill.style.width = Math.min(currentProgress, 100) + "%";

        // 可视化压力变色
        const currentColor = getScientificColor(elapsedMins);
        fill.style.background = currentColor;

        const glowColor = currentColor.includes("rgb")
          ? currentColor.replace("rgb", "rgba").replace(")", ", 0.5)")
          : `${currentColor}80`;

        fill.style.setProperty("--current-glow-color", glowColor);

        //如果正在预览，就不更新 status 文字
        if (isPreviewing) return;

        // 到达目标后的逻辑
        if (elapsedSeconds >= targetSeconds) {
          // 触发警报，但不再 clearInterval
          if (!document.body.classList.contains("danger-mode")) {
            triggerAlarm();
          }
          status.innerText = `到点啦！请起身活动身体 | 已超过设定时间 ${formatTime(
            elapsedSeconds - targetSeconds
          )}`;
          status.style.color = "var(--danger)";
        } else {
          const config = getStatusConfig(elapsedMins);
          status.innerText = config.text;
          status.style.color = config.color;
        }
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, "0")}:${s
          .toString()
          .padStart(2, "0")}`;
      }

      function triggerAlarm() {
        alarm.play().catch(() => {});
        document.body.classList.add("danger-mode");
        const hint = document.getElementById("hint");
        if (navigator.vibrate) {
          // 触发一组震动：震动500ms，停200ms，再震动500ms
          navigator.vibrate([500, 200, 500]);
        }
        hint.innerText = "点击背景空白处重置";
        hint.style.color = "var(--text-sub)";
      }

      function resetState() {
        alarm.pause();
        alarm.currentTime = 0;
        document.body.classList.remove("danger-mode");
      }

      // 交互逻辑
      const startEvent = (e) => {
        isDragging = true;
        handlePosition(e.touches ? e.touches[0].clientX : e.clientX);
      };
      const moveEvent = (e) => {
        if (!isDragging) return;
        handlePosition(e.touches ? e.touches[0].clientX : e.clientX);
      };
      const endEvent = () => {
        if (isDragging) {
          isDragging = false;
          startTiming();
          // 松手后，预览文字保留 3 秒
          previewTimer = setTimeout(() => {
            isPreviewing = false;
          }, 3000); // 3000毫秒 = 3秒，你可以根据需要调整
        }
      };

      touchZone.addEventListener("touchstart", startEvent, { passive: false });
      window.addEventListener("touchmove", moveEvent, { passive: false });
      window.addEventListener("touchend", endEvent);
      touchZone.addEventListener("mousedown", startEvent);
      window.addEventListener("mousemove", moveEvent);
      window.addEventListener("mouseup", endEvent);

      // 新增休息时间配置（秒），建议 120 秒（2分钟）
      const REST_DURATION = 120;
      let isResting = false;
      let restTimer = null;

      // 修改后的点击处理逻辑
      document.body.addEventListener("click", (e) => {
        // 只有在报警模式下点击背景才触发
        if (document.body.classList.contains("danger-mode") && !isResting) {
          if (!document.getElementById("app").contains(e.target)) {
            document.getElementById("hint").innerText = "";
            startRestPhase();
          }
        }
      });

      function startRestPhase() {
        isResting = true;
        resetState(); // 停止报警声音和动画
        if (timer) clearInterval(timer);

        let restRemaining = REST_DURATION;
        status.innerText = "太棒了！请起身活动 (建议深蹲或远眺)";
        status.style.color = "#2ecc71";
        document.body.style.backgroundColor = "#e8f8f5"; // 背景变淡绿

        restTimer = setInterval(() => {
          restRemaining--;
          countdown.innerText = formatTime(restRemaining);

          // 进度条反向缩减效果
          const restProgress = (restRemaining / REST_DURATION) * 100;
          fill.style.width = restProgress + "%";
          fill.style.background = "#2ecc71";

          if (restRemaining <= 0) {
            endRestPhase();
          }
        }, 1000);
      }

      function endRestPhase() {
        clearInterval(restTimer);
        isResting = false;
        document.body.style.backgroundColor = "var(--bg-color)";

        // 播放逻辑
        const playPromise = alarm.play();

        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              // 播放成功，1秒后停止
              setTimeout(() => {
                alarm.pause();
                alarm.currentTime = 0;
              }, 2000);
            })
            .catch((error) => {
              console.error("音频播放被拦截:", error);
              // 如果自动播放失败，可以考虑改用弹窗提醒，用户点击弹窗后再响铃
            });
        }

        // 自动重新开始下一轮计时
        startTime = Date.now();
        countdown.innerText = "00:00";
        fill.style.width = "0%";
        status.innerText = "新一轮计时已自动开始...";
        timer = setInterval(update, 500); // 恢复主更新循环
      }

      async function requestLandscape() {
        try {
          const de = document.documentElement;
          if (de.requestFullscreen) {
            await de.requestFullscreen();
          }

          if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock("landscape");
          }

          setTimeout(() => {
            window.scrollTo(0, 0);
            // 触发一个微小的位移再还原，强迫浏览器重新计算 flex 居中
            document.body.style.display = "none";
            document.body.offsetHeight; // 触发 reflow
            document.body.style.display = "flex";
          }, 300);
        } catch (err) {
          console.warn("自动锁定失败:", err);
        }
      }
    </script>
  </body>
</html>

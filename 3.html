<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>久坐提醒</title>
    <style>
      :root {
        --bg-color: #f0f3f7;
        --card-bg: #ffffff;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --primary: #2ecc71;
        --danger: #e74c3c;
        --track-bg: #e9ecef;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background-color: var(--bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        touch-action: none;
      }

      .container {
        width: 85%;
        max-width: 800px;
        /* 使用 min-height 确保在小屏幕上不会缩得太小 */
        height: 75vh;
        min-height: 350px;
        max-height: 500px;

        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;

        background: var(--card-bg);
        padding: 50px 30px; /* 使用固定像素内边距，布局更稳固 */
        border-radius: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        text-align: center;
        box-sizing: border-box;
        transition: all 0.5s ease;
      }

      .timer-display {
        /* 使用 clamp 限制字体大小范围，防止在超大或超小屏幕失控 */
        font-size: clamp(4rem, 18vw, 6rem);
        font-weight: 800;
        color: var(--text-main);
        letter-spacing: -2px;
        font-variant-numeric: tabular-nums;
        margin: 0; /* 移除 Margin，由容器分配间距 */
        line-height: 1;
      }

      .status-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-sub);
        margin: 0;
        min-height: 3rem; /* 固定高度防止文字换行时抖动 */
        display: flex;
        align-items: center;
        transition: color 0.3s ease;
      }

      .progress-wrapper {
        width: 100%;
        position: relative;
        padding: 20px 0; /* 增加触摸感应区域 */
        touch-action: none;
        cursor: pointer;
      }

      .progress-container {
        position: relative;
        width: 100%;
        height: 64px; /* 进度条高度固定更美观 */
        background-color: var(--track-bg);
        border-radius: 20px;
        overflow: visible;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .progress-mask {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 20px;
        overflow: hidden;
        pointer-events: none;
      }

      .progress-fill {
        height: 100%;
        width: 0%;
        background: var(--primary);
        transition: width 0.4s cubic-bezier(0.23, 1, 0.32, 1),
          background 0.5s linear;
      }

      .marker {
        position: absolute;
        top: 50%;
        height: 80px; /* 标尺稍微高出进度条 */
        width: 8px;
        background-color: var(--text-main);
        border-radius: 10px;
        z-index: 10;
        display: none;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }

      .hint {
        font-size: 0.85rem;
        font-weight: 500;
        color: #b2bec3;
        letter-spacing: 1px;
        margin: 0;
      }

      /* 报警动画优化 */
      @keyframes alert-pulse {
        0% {
          transform: scale(1);
          background-color: #ffffff;
        }
        100% {
          transform: scale(1.02);
          background-color: #fff5f5;
        }
      }

      .danger-mode .container {
        animation: alert-pulse 0.5s infinite alternate ease-in-out;
        border: 2px solid var(--danger);
      }

      /* 默认隐藏提示按钮 */
      #landscape-suggestion {
        display: none;
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
      }

      /* 仅在手机端 (宽度小于600px) 且处于竖屏时显示 */
      @media screen and (orientation: portrait) and (max-width: 600px) {
        #landscape-suggestion {
          display: block;
          animation: fadeInUp 0.8s ease-out;
        }
      }

      #landscape-suggestion button {
        background: rgba(45, 52, 54, 0.95);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.1);
        padding: 12px 28px;
        border-radius: 100px; /* 圆角胶囊形状 */
        backdrop-filter: blur(10px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #landscape-suggestion small {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 4px;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translate(-50%, 30px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }
    </style>
  </head>
  <body>
    <div id="landscape-suggestion">
      <button onclick="requestLandscape()">
        <span style="font-size: 20px">⇄ 旋转</span>
        <small>横屏视野更舒适</small>
      </button>
    </div>
    <div class="container" id="app">
      <div class="timer-display" id="countdown">00:00</div>
      <div class="status-text" id="status">滑动时间轴设定提醒</div>

      <div class="progress-wrapper" id="touchZone">
        <div class="progress-container">
          <div class="marker" id="marker"></div>
          <div class="progress-mask">
            <div class="progress-fill" id="fill"></div>
          </div>
        </div>
      </div>

      <div class="hint" id="hint"></div>
    </div>

    <audio id="alarm" loop>
      <source
        src="https://www.soundjay.com/buttons/beep-01a.mp3"
        type="audio/mpeg"
      />
    </audio>

    <script>
      const touchZone = document.getElementById("touchZone");
      const fill = document.getElementById("fill");
      const marker = document.getElementById("marker");
      const status = document.getElementById("status");
      const alarm = document.getElementById("alarm");
      const countdown = document.getElementById("countdown");

      let startTime = 0;
      let targetSeconds = 0;
      let timer = null;
      let isDragging = false;
      const MAX_MINUTES = 120;

      // 颜色插值算法
      function getScientificColor(mins) {
        if (mins <= 45) return "#2ecc71"; // 绿色
        if (mins <= 60)
          return interpolateColor("#2ecc71", "#f1c40f", (mins - 45) / 15); // 绿到黄
        if (mins <= 90)
          return interpolateColor("#f1c40f", "#e67e22", (mins - 60) / 30); // 黄到橙
        return interpolateColor("#e67e22", "#e74c3c", (mins - 90) / 30); // 橙到红
      }

      function interpolateColor(c1, c2, factor) {
        const hex = (x) => parseInt(x.replace("#", ""), 16);
        const r1 = (hex(c1) >> 16) & 0xff,
          g1 = (hex(c1) >> 8) & 0xff,
          b1 = hex(c1) & 0xff;
        const r2 = (hex(c2) >> 16) & 0xff,
          g2 = (hex(c2) >> 8) & 0xff,
          b2 = hex(c2) & 0xff;
        const r = Math.round(r1 + factor * (r2 - r1));
        const g = Math.round(g1 + factor * (g2 - g1));
        const b = Math.round(b1 + factor * (b2 - b1));
        return `rgb(${r}, ${g}, ${b})`;
      }

      // 在脚本开头定义一个变量记录上次震动的分钟数
      let lastVibratedMin = -1;

      // 修改原有的交互逻辑，确保手动滑动时依然可以重置旧的计时
      function handlePosition(clientX) {
        // 如果在报警时手动滑动，先关掉报警
        if (document.body.classList.contains("danger-mode")) {
          resetState();
        }

        const hintElement = document.getElementById("hint");
        if (hintElement) hintElement.innerText = "";

        const rect = touchZone
          .querySelector(".progress-container")
          .getBoundingClientRect();
        let percentage = (clientX - rect.left) / rect.width;
        percentage = Math.max(0, Math.min(1, percentage));

        const mins = Math.round(percentage * MAX_MINUTES);
        if (mins === 0) return;

        targetSeconds = mins * 60;
        marker.style.left = `${(mins / MAX_MINUTES) * 100}%`;
        marker.style.display = "block";

        status.innerText = `将在坐满 ${mins} 分钟时提醒`;
        status.style.color = getScientificColor(mins);

        if (navigator.vibrate && mins !== lastVibratedMin) {
          navigator.vibrate(50);
          lastVibratedMin = mins;
        }
      }

      function startTiming() {
        if (targetSeconds <= 0) return;
        resetState();
        startTime = Date.now();
        if (timer) clearInterval(timer);
        timer = setInterval(update, 500);
      }

      function update() {
        if (startTime === 0) return;

        const elapsedSeconds = (Date.now() - startTime) / 1000;
        const elapsedMins = elapsedSeconds / 60;

        // 更新计时显示 (即使超过目标也会继续走)
        countdown.innerText = formatTime(elapsedSeconds);

        // 进度条宽度
        const currentProgress = (elapsedSeconds / (MAX_MINUTES * 60)) * 100;
        fill.style.width = Math.min(currentProgress, 100) + "%";

        // 可视化压力变色
        const currentColor = getScientificColor(elapsedMins);
        fill.style.background = currentColor;

        const glowColor = currentColor.includes("rgb")
          ? currentColor.replace("rgb", "rgba").replace(")", ", 0.5)")
          : `${currentColor}80`;

        fill.style.boxShadow = `0 0 20px ${glowColor}`;

        // 到达目标后的逻辑
        if (elapsedSeconds >= targetSeconds) {
          // 触发警报，但不再 clearInterval
          if (!document.body.classList.contains("danger-mode")) {
            triggerAlarm();
          }
          status.innerText = `到点啦！请起身活动身体 | 已超过设定时间 ${formatTime(
            elapsedSeconds - targetSeconds
          )}`;
          status.style.color = "var(--danger)";
        } else {
          // 未到达目标时的状态显示
          if (elapsedMins < 60) {
            status.innerText = "状态：良好";
            status.style.color = "var(--text-sub)";
          } else {
            status.innerText = "状态：久坐警告";
            status.style.color = currentColor;
          }
        }
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, "0")}:${s
          .toString()
          .padStart(2, "0")}`;
      }

      function triggerAlarm() {
        alarm.play().catch(() => {});
        document.body.classList.add("danger-mode");
        const hint = document.getElementById("hint");
        hint.innerText = "点击背景空白处重置";
        hint.style.color = "var(--text-sub)";
      }

      function resetState() {
        alarm.pause();
        alarm.currentTime = 0;
        document.body.classList.remove("danger-mode");
      }

      // 交互逻辑
      const startEvent = (e) => {
        isDragging = true;
        handlePosition(e.touches ? e.touches[0].clientX : e.clientX);
      };
      const moveEvent = (e) => {
        if (!isDragging) return;
        handlePosition(e.touches ? e.touches[0].clientX : e.clientX);
      };
      const endEvent = () => {
        if (isDragging) {
          isDragging = false;
          startTiming();
        }
      };

      touchZone.addEventListener("touchstart", startEvent, { passive: false });
      window.addEventListener("touchmove", moveEvent, { passive: false });
      window.addEventListener("touchend", endEvent);
      touchZone.addEventListener("mousedown", startEvent);
      window.addEventListener("mousemove", moveEvent);
      window.addEventListener("mouseup", endEvent);

      document.body.addEventListener("click", (e) => {
        // 只有当正处于报警模式（danger-mode），且点击的是背景（非 app 容器内部）时触发
        if (document.body.classList.contains("danger-mode")) {
          if (!document.getElementById("app").contains(e.target)) {
            resetState();
            startTime = Date.now();
            countdown.innerText = "00:00";
            fill.style.width = "0%";
            status.innerText = "已重新开始计时...";
            document.getElementById("hint").innerText = "";
            if (timer) clearInterval(timer);
            timer = setInterval(update, 500);
          }
        }
      });

      async function requestLandscape() {
        try {
          // 1. 现代浏览器需要先进入全屏模式才能锁定方向
          const de = document.documentElement;
          if (de.requestFullscreen) {
            await de.requestFullscreen();
          } else if (de.webkitRequestFullscreen) {
            await de.webkitRequestFullscreen();
          }

          // 2. 尝试锁定为横屏 (Landscape)
          if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock("landscape");
          }
        } catch (err) {
          // 兼容处理：例如 iOS Safari 不支持直接锁定，则提醒用户
          console.warn("自动锁定失败:", err);
          alert("请关闭手机系统的「旋转锁定」开关，然后横过手机即可。");
        }
      }
    </script>
  </body>
</html>
